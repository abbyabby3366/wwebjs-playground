import{_ as pa}from"../chunks/C1FmrZbK.js";import"../chunks/CWj6FrbW.js";import{i as ua}from"../chunks/DbVienwh.js";import{p as va,o as ga,q as ma,f as N,h as fa,u as Q,j as I,l as T,a as w,b as ba,$ as ha,g as t,m as W,s as m,v as K,e as r,c as o,r as a,k as C,w as _t,x as xa,y as ya,z as Et,i as wt}from"../chunks/CPPbwToL.js";import{i as G}from"../chunks/BBMtWJJw.js";import{e as At,i as St}from"../chunks/HMgc3kw4.js";import{r as dt,b as ot,s as _a}from"../chunks/DF61nx8T.js";import{s as st}from"../chunks/mMo-1mwx.js";import{b as wa}from"../chunks/CS9i7cT0.js";var Ca=N('<div class="p-4 text-center text-gray-500"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto mb-2"></div> Loading contacts...</div>'),ka=N('<div class="p-6 text-center text-gray-500"><div class="text-4xl mb-3">💬</div> <h3 class="text-lg font-medium mb-2">No conversations yet</h3> <p class="text-sm mb-4">Start chatting with your customers</p> <button class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm">Start New Chat</button></div>'),Ma=N('<span class="ml-2 text-xs text-green-600">👥</span>'),Na=N('<span class="text-xs text-gray-500"> </span>'),Ta=N(" <!>",1),Ga=N('<div><div class="flex items-center space-x-3"><div> </div> <div class="flex-1 min-w-0"><div class="flex items-center justify-between"><h3 class="text-sm font-medium text-gray-900 truncate"> <!></h3> <div class="flex items-center space-x-1"><div></div> <!></div></div> <p class="text-sm text-gray-600 truncate"><!></p></div></div></div>'),Pa=N('<div class="chat-header"><div class="flex items-center space-x-3"><div class="w-10 h-10 bg-gray-300 rounded-full flex items-center justify-center text-sm font-medium text-gray-700"> </div> <div><h3 class="text-lg font-semibold text-gray-900"> </h3> <p class="text-sm text-gray-600"> </p></div> <div class="ml-auto flex items-center space-x-2"><button class="lg:hidden p-2 text-gray-600 hover:bg-gray-100 rounded-lg transition-colors" title="Toggle contact info"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></button> <div></div> <span class="text-sm text-gray-500 capitalize"> </span></div></div></div>'),$a=N('<span class="text-xs opacity-60 ml-1"> </span>'),Da=N('<span class="text-xs opacity-60 ml-1"> </span>'),ja=N('<div class="text-xs opacity-75 mb-1 font-medium cursor-pointer hover:opacity-100 transition-opacity" title="Click to view contact details"> <!> <!></div>'),Ea=N('<span class="text-yellow-300">⏳</span>'),Aa=N('<span class="text-red-300">✓</span>'),Sa=N('<span class="text-red-300">❌</span>'),Ia=N('<span class="text-gray-300">✓</span>'),Ua=N('<span class="ml-2"><!></span>'),Fa=N('<div><div><!> <div class="text-sm whitespace-pre-wrap"> </div> <div class="text-xs opacity-75 mt-1 text-right"> <!></div></div></div>'),za=N('<div class="flex items-center justify-center h-full"><div class="text-center text-gray-500"><div class="text-6xl mb-4">💬</div> <h3 class="text-lg font-medium mb-2">Select a contact to start chatting</h3> <p class="text-sm">Choose from the list on the left to begin a conversation</p></div></div>'),Ra=N('<div class="chat-input"><div class="flex space-x-3"><input placeholder="Type your message..." class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"/> <button class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed">Send</button></div></div>'),La=N('<div class="mb-4"><button class="flex items-center text-sm text-blue-600 hover:text-blue-800 transition-colors mb-4"><svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg> Back to Group</button></div> <div class="text-center mb-6"><div class="w-20 h-20 bg-gray-300 rounded-full flex items-center justify-center text-2xl font-medium mx-auto mb-3 text-gray-700"> </div> <h2 class="text-xl font-bold text-gray-900 mb-1"> </h2> <p class="text-sm text-gray-600 mb-2">Group Member</p></div> <div class="space-y-4"><div class="bg-white rounded-lg p-4"><h3 class="text-sm font-semibold text-gray-900 mb-3">Contact Information</h3> <div class="space-y-3"><div><label class="text-xs font-medium text-gray-500 uppercase tracking-wide">Phone Number</label> <p class="text-sm text-gray-900 font-mono"> </p></div> <div><label class="text-xs font-medium text-gray-500 uppercase tracking-wide">Group</label> <p class="text-sm text-gray-900"> </p></div></div></div> <div class="bg-white rounded-lg p-4"><h3 class="text-sm font-semibold text-gray-900 mb-3">Quick Actions</h3> <div class="space-y-2"><button class="w-full px-3 py-2 bg-blue-50 text-blue-700 rounded-lg hover:bg-blue-100 transition-colors text-sm">💬 Start Individual Chat</button> <button class="w-full px-3 py-2 bg-purple-50 text-purple-700 rounded-lg hover:bg-purple-100 transition-colors text-sm">📝 Edit Contact</button></div></div></div>',1),Oa=N('<div class="text-sm text-gray-700 bg-gray-50 px-2 py-1 rounded cursor-pointer hover:bg-gray-100 transition-colors flex items-center justify-between group" title="Click to view contact details"><span> </span> <svg class="w-5 h-5 text-blue-500 group-hover:text-blue-600 transition-colors flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg></div>'),Ba=N('<div class="text-xs text-gray-500 text-center"> </div>'),Wa=N('<div><label class="text-xs font-medium text-gray-500 uppercase tracking-wide">Members</label> <div class="space-y-1"><!> <!></div></div>'),Ha=N('<div><label class="text-xs font-medium text-gray-500 uppercase tracking-wide">Participants</label> <p class="text-sm text-gray-900"> </p></div> <!>',1),Ja=N('<div class="mt-3 pt-3 border-t border-gray-100"><div class="text-center"><div class="text-sm text-gray-900"> </div> <div class="text-xs text-gray-500"> </div></div></div>'),Ya=N('<button class="w-full px-3 py-2 bg-green-50 text-green-700 rounded-lg hover:bg-green-100 transition-colors text-sm">👥 Manage Group</button>'),qa=N('<div class="text-center mb-6"><div> </div> <h2 class="text-xl font-bold text-gray-900 mb-1"> </h2> <p class="text-sm text-gray-600 mb-2"> </p> <div class="flex items-center justify-center space-x-2"><div></div> <span class="text-sm text-gray-500 capitalize"> </span></div></div> <div class="space-y-4"><div class="bg-white rounded-lg p-4"><h3 class="text-sm font-semibold text-gray-900 mb-3">Contact Information</h3> <div class="space-y-3"><div><label class="text-xs font-medium text-gray-500 uppercase tracking-wide">Phone Number</label> <p class="text-sm text-gray-900 font-mono"> </p></div> <!></div></div> <div class="bg-white rounded-lg p-4"><h3 class="text-sm font-semibold text-gray-900 mb-3">Chat Statistics</h3> <div class="grid grid-cols-2 gap-4"><div class="text-center"><div class="text-2xl font-bold text-blue-600"> </div> <div class="text-xs text-gray-500">Total Messages</div></div> <div class="text-center"><div class="text-2xl font-bold text-green-600"> </div> <div class="text-xs text-gray-500">Conversations</div></div></div> <!></div> <div class="bg-white rounded-lg p-4"><h3 class="text-sm font-semibold text-gray-900 mb-3">Quick Actions</h3> <div class="space-y-2"><button class="w-full px-3 py-2 bg-blue-50 text-blue-700 rounded-lg hover:bg-blue-100 transition-colors text-sm">📝 Edit Contact</button> <!> <button class="w-full px-3 py-2 bg-purple-50 text-purple-700 rounded-lg hover:bg-purple-100 transition-colors text-sm">📊 View History</button></div></div></div>',1),Qa=N('<div class="p-6"><div class="lg:hidden flex justify-end mb-4"><button class="p-2 text-gray-500 hover:bg-gray-200 rounded-lg transition-colors" title="Close panel"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button></div> <!></div>'),Ka=N('<div class="flex items-center justify-center h-full"><div class="text-center text-gray-500"><div class="text-4xl mb-3">ℹ️</div> <h3 class="text-lg font-medium mb-2">Contact Information</h3> <p class="text-sm">Select a contact to view details</p></div></div>'),Va=N('<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"><div class="bg-white rounded-lg p-6 max-w-md w-full mx-4"><h3 class="text-lg font-semibold mb-4">Start New Chat</h3> <div class="space-y-4"><div><label for="newChatName" class="block text-sm font-medium text-gray-700 mb-1">Contact Name (Optional)</label> <input id="newChatName" placeholder="Enter contact name" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"/></div> <div><label for="newChatPhone" class="block text-sm font-medium text-gray-700 mb-1">Phone Number *</label> <input id="newChatPhone" placeholder="+1234567890" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required/></div></div> <div class="flex justify-end space-x-3 mt-6"><button class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200">Cancel</button> <button class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50">Start Chat</button></div></div></div>'),Xa=N('<button class="px-3 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 text-sm">Remove</button>'),Za=N('<div class="ml-2 text-xs text-gray-500 mb-2"><!></div>'),tr=N('<div class="flex space-x-2 mb-2"><input placeholder="Phone number (e.g., 60122273341)" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"/> <!></div> <!>',1),er=N('<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"><div class="bg-white rounded-lg p-6 max-w-md w-full mx-4"><h3 class="text-lg font-semibold mb-4">Create New Group</h3> <div class="space-y-4"><div><label class="block text-sm font-medium text-gray-700 mb-1">Group Title *</label> <input placeholder="Enter group title" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"/></div> <div><label class="block text-sm font-medium text-gray-700 mb-1">Participants *</label> <!> <button class="px-3 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 text-sm">+ Add Participant</button></div></div> <div class="flex justify-end space-x-3 mt-6"><button class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200">Cancel</button> <button class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50">Create Group</button></div></div></div>'),ar=N('<tr><td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900"> </td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"> </td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"> </td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"> </td><td class="px-6 py-4 whitespace-nowrap text-sm font-medium"><div class="flex space-x-2"><button class="text-indigo-600 hover:text-indigo-900">Edit</button> <button class="text-red-600 hover:text-red-900">Delete</button></div></td></tr>'),rr=N('<div class="text-center py-8 text-gray-500"><div class="text-4xl mb-3">👥</div> <h3 class="text-lg font-medium mb-2">No contacts yet</h3> <p class="text-sm mb-4">Add your first contact to get started</p> <button class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm">Add First Contact</button></div>'),or=N('<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"><div class="bg-white rounded-lg p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto"><div class="flex justify-between items-center mb-6"><h3 class="text-lg font-semibold">Contact Manager</h3> <div class="flex space-x-2"><button class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm">+ Add Contact</button> <button class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200">Close</button></div></div> <div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Phone</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Notes</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th></tr></thead><tbody class="bg-white divide-y divide-gray-200"></tbody></table></div> <!></div></div>'),sr=N('<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"><div class="bg-white rounded-lg p-6 max-w-md w-full mx-4"><h3 class="text-lg font-semibold mb-4"> </h3> <div class="space-y-4"><div><label class="block text-sm font-medium text-gray-700 mb-1">Name *</label> <input placeholder="Enter contact name" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"/></div> <div><label class="block text-sm font-medium text-gray-700 mb-1">Phone Number *</label> <input placeholder="e.g., 60122273341" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"/></div> <div><label class="block text-sm font-medium text-gray-700 mb-1">Email</label> <input placeholder="Enter email address" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"/></div> <div><label class="block text-sm font-medium text-gray-700 mb-1">Notes</label> <textarea placeholder="Add any notes about this contact" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea></div></div> <div class="flex justify-end space-x-3 mt-6"><button class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200">Cancel</button> <button class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50"> </button></div></div></div>'),nr=N('<div class="space-y-4"><div class="text-center mb-4"><div class="w-16 h-16 bg-blue-300 rounded-full flex items-center justify-center text-xl font-medium mx-auto mb-3 text-blue-700"> </div> <h2 class="text-lg font-bold text-gray-900 mb-1"> </h2> <p class="text-sm text-gray-600">Contact</p></div> <div class="bg-gray-50 rounded-lg p-4"><h3 class="text-sm font-semibold text-gray-900 mb-3">Contact Information</h3> <div class="space-y-3"><div><label class="text-xs font-medium text-gray-500 uppercase tracking-wide">Phone Number</label> <p class="text-sm text-gray-900 font-mono"> </p></div> <div><label class="text-xs font-medium text-gray-500 uppercase tracking-wide">Type</label> <p class="text-sm text-gray-900 capitalize"> </p></div></div></div> <div class="bg-gray-50 rounded-lg p-4"><h3 class="text-sm font-semibold text-gray-900 mb-3">Quick Actions</h3> <div class="space-y-2"><button class="w-full px-3 py-2 bg-blue-50 text-blue-700 rounded-lg hover:bg-blue-100 transition-colors text-sm">💬 Start Individual Chat</button> <button class="w-full px-3 py-2 bg-purple-50 text-purple-700 rounded-lg hover:bg-purple-100 transition-colors text-sm">📝 Manage Contacts</button></div></div></div>'),ir=N('<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"><div class="bg-white rounded-lg p-6 max-w-md w-full mx-4"><div class="flex justify-between items-center mb-4"><h3 class="text-lg font-semibold text-gray-900">Contact Details</h3> <button class="p-2 text-gray-500 hover:bg-gray-200 rounded-lg transition-colors" title="Close"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button></div> <!></div></div>'),lr=N('<div class="chat-container h-full flex bg-gray-50"><div class="w-80 border-r border-gray-200 flex flex-col flex-shrink-0 bg-white shadow-sm"><div class="p-4 border-b border-gray-200"><div class="flex items-center justify-between mb-2"><h2 class="text-lg font-semibold text-gray-900">Contacts</h2> <div class="flex space-x-2"><button class="p-2 text-purple-600 hover:bg-purple-50 rounded-lg transition-colors" title="Manage contacts"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg></button> <button class="p-2 text-green-600 hover:bg-green-50 rounded-lg transition-colors" title="Create new group"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg></button> <button class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition-colors" title="Start new chat"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg></button></div></div> <p class="text-sm text-gray-600 mb-2">Manage customer conversations and groups</p> <div class="flex space-x-2"><button class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600 transition-colors">New Chat</button> <button class="bg-green-500 text-white px-3 py-1 rounded text-sm hover:bg-green-600 transition-colors"> </button> <button class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600 transition-colors">👤 Refresh Contact Names</button></div></div> <div class="overflow-y-auto flex-1"><!></div></div> <div class="flex-1 flex flex-col border-r border-gray-200 min-w-0 bg-white shadow-sm"><!> <div class="chat-messages"><!></div> <!></div> <div><!></div></div> <!> <!> <!> <!> <!>',1);function hr(we,Ce){va(Ce,!1);let nt,gt=W(""),h=W(null),F=W([]),P=W([]),mt=W(),Ct=W(!1),tt=W(""),It=W(""),pt=W(!1),Ut=W(!1),D=W({title:"",participants:[""]}),ft=W(!1),bt=W(!1),V=W(null),kt=W(!1),et=W(null),ut=W([]),Mt=W(!1),O=W({name:"",phone:"",email:"",notes:""}),at=W(null);ga(async()=>{console.log("onMount started"),await Ht(),console.log("About to load contacts..."),await ke(),console.log("Contacts loaded, count:",t(P).length);const e=t(P).filter(n=>n.type==="group").length;console.log(`Groups loaded: ${e}`);try{const{io:n}=await pa(async()=>{const{io:s}=await import("../chunks/wSuXe0Ee.js");return{io:s}},[],import.meta.url);nt=n(),nt.on("connect",()=>{console.log("Connected to server")}),nt.on("whatsapp_status",s=>{console.log("WhatsApp status:",s)}),nt.on("new_message",s=>{var c,f;if(console.log("New message received via WebSocket:",s),console.log("Current selected contact:",t(h)),console.log("Message isGroup flag:",s.isGroup),console.log("Message groupId:",s.groupId),t(F).some(v=>{const l=v.content===s.content,d=v.direction===s.direction,p=t(h)&&(v.direction==="sent"&&v.to===t(h).phone||v.direction==="received"&&v.from===t(h).phone),x=Math.abs(v.timestamp.getTime()-new Date(s.timestamp).getTime())<5e3;return l&&d&&p&&x})){console.log("Message already exists, skipping duplicate:",s);return}if(t(h)){const v=t(h).phone,l=s.fromMe?s.to:s.from;console.log("Processing new message for selected contact:",{selectedContact:{phone:v,type:t(h).type,name:t(h).name},newMessage:{isGroup:s.isGroup,from:s.from,to:s.to,groupId:s.groupId,content:s.content}});let d=!1;if(t(h).type==="group"){const p=v.includes("@g.us")?v:v.replace("group_","");d=s.isGroup&&(s.to===p||s.groupId===p),console.log("Group message check:",{selectedGroup:p,messageTo:s.to,messageGroupId:s.groupId,isGroupMessage:s.isGroup,shouldAdd:d})}else d=!s.isGroup&&l===v,console.log("Individual message check:",{selectedContact:v,messageContact:l,isGroupMessage:s.isGroup,shouldAdd:d});if(d){const p={id:s.id,direction:s.direction,type:s.type,content:s.content,from:s.fromMe?"You":J(s.from),fromPhone:s.realPhoneNumber||s.from,to:s.to,timestamp:new Date(s.timestamp),status:s.status,contact:s.fromMe?s.to:s.from,isGroup:t(h).type==="group",realPhoneNumber:s.realPhoneNumber,groupParticipantPhone:s.realPhoneNumber};m(F,[...t(F),p]),Bt(),console.log("Message added to current chat:",p),console.log("Message type validation:",{selectedContactType:t(h).type,messageIsGroup:s.isGroup,transformedMessageIsGroup:p.isGroup})}else console.log("Message NOT added to current chat:",{reason:"Message doesn't belong to current contact/group",selectedContact:(c=t(h))==null?void 0:c.name,selectedContactType:(f=t(h))==null?void 0:f.type,messageIsGroup:s.isGroup,messageContent:s.content})}Ae(s),Ft()}),nt.on("message_received",s=>{console.log("Message received:",s)}),nt.on("disconnect",()=>{console.log("Disconnected from server")})}catch(n){console.error("Error setting up WebSocket:",n)}console.log("Checking if contacts exist for auto-selection..."),t(P).length>0?(console.log("Auto-selecting first contact:",t(P)[0]),Nt(t(P)[0])):console.log("No contacts available for auto-selection"),console.log("onMount completed")});async function re(){if(!t(tt).trim())return;const e=J(t(tt).trim()),n=e!==t(tt).trim()?e:t(It).trim()||t(tt),s=n.split(" ").map(c=>c[0]).join("").toUpperCase().slice(0,2),i={id:Date.now(),name:n,phone:t(tt).trim(),avatar:s,status:"offline",lastMessage:"Start a new conversation",messageCount:0,type:"contact"};m(P,[i,...t(P)]),Nt(i),m(tt,""),m(It,""),m(Ct,!1)}async function ke(){m(pt,!0);let e=0;const n=3;for(;e<n;)try{console.log(`Attempt ${e+1} to load contacts...`);const i=await(await fetch("/api/mongodb/messages/recent?limit=100")).json();if(console.log("Raw response from /api/mongodb/messages/recent:",i),i.success&&i.messages&&i.messages.length>0){console.log("Found messages, processing contacts..."),console.log("First message example:",i.messages[0]);const c=new Map;i.messages.forEach((d,p)=>{var _,k;if(console.log(`Processing message ${p}:`,d),((_=d.metadata)==null?void 0:_.isGroup)||d.to&&d.to.includes("@g.us")||d.from&&d.from.includes("@g.us")){console.log(`Message ${p} - Skipping group message:`,d.to||d.from);return}const x=((k=d.metadata)==null?void 0:k.realPhoneNumber)||(d.from?d.from.replace("@c.us",""):null),g=d.to?d.to.replace("@c.us",""):null,y=d.fromMe!==void 0?d.fromMe:d.from===null,b=y?g:x;if(console.log(`Message ${p} - fromPhone: ${x}, toPhone: ${g}, isFromMe: ${y}, contactPhone: ${b}`),b&&!c.has(b)){const M=J(b),j=M!==b?M:d.pushname||b.replace(/\D/g,""),R=j.split(" ").map(U=>U[0]).join("").toUpperCase().slice(0,2),S={id:c.size+1,name:j,phone:b,avatar:R,status:"offline",lastMessage:d.body||"No message",lastMessageTime:new Date(d.timestamp),messageCount:1,type:"contact"};console.log("Creating new contact:",S),c.set(b,S)}else if(b&&c.has(b)){const M=c.get(b);M.messageCount+=1,new Date(d.timestamp)>M.lastMessageTime&&(M.lastMessage=d.body||"No message",M.lastMessageTime=new Date(d.timestamp)),console.log("Updated existing contact:",M)}else console.log(`Message ${p} - No valid contact phone found`)});let f=!1,v=0;const l=3;for(;!f&&v<l;)try{console.log(`Attempt ${v+1} to load groups...`);const d=await fetch("/api/whatsapp/groups");if(!d.ok)throw new Error(`HTTP ${d.status}: ${d.statusText}`);const p=await d.json();if(console.log("Groups response:",p),p.success&&p.groups){const u=p.groups.map((x,g)=>{let y=[],b=[];return x.participants&&Array.isArray(x.participants)&&(b=x.participants.map(_=>{const k=_.id?_.id.replace("@c.us",""):_.replace("@c.us",""),M=J(k);return{phone:k,name:M,original:_}}),y=b.map(_=>_.name)),{id:`group_${g+1e3}`,name:x.name||x.title||`Group ${g+1}`,phone:x.id,avatar:"👥",status:"online",lastMessage:y.length>0?`${y.length} participants`:"Group chat",lastMessageTime:null,messageCount:0,type:"group",participantsCount:x.participantsCount||0,participants:x.participants||[],participantNames:y,participantData:b}});u.forEach(x=>{const g=x.phone,y=i.messages.filter(b=>{const _=b.from?b.from.replace("@g.us",""):"",k=b.to?b.to.replace("@g.us",""):"",M=g.replace("@g.us","");return _===M||k===M});if(x.messageCount=y.length,y.length>0){const b=y.sort((_,k)=>new Date(k.timestamp)-new Date(_.timestamp))[0];x.lastMessage=b.body||"Group message",x.lastMessageTime=new Date(b.timestamp)}c.set(x.phone,x)}),console.log("Groups loaded and added to contacts with message counts:",u),f=!0;break}else throw new Error(`Groups API returned: ${JSON.stringify(p)}`)}catch(d){v++,console.error(`Error loading groups (attempt ${v}):`,d),v<l?(console.log(`Retrying group load in ${v*1e3}ms...`),await new Promise(p=>setTimeout(p,v*1e3))):console.error("Failed to load groups after all retries")}m(P,Array.from(c.values()).sort((d,p)=>!d.lastMessageTime&&!p.lastMessageTime?0:d.lastMessageTime?p.lastMessageTime?new Date(p.lastMessageTime)-new Date(d.lastMessageTime):-1:1)),Ft(),console.log("Final contacts array with timestamps:",t(P).map(d=>({name:d.name,phone:d.phone,type:d.type,lastMessageTime:d.lastMessageTime,lastMessage:d.lastMessage})));break}else throw new Error(`No messages found. Response: ${JSON.stringify(i)}`)}catch(s){e++,console.error(`Error loading contacts (attempt ${e}):`,s),e<n?(console.log(`Retrying contact load in ${e*1e3}ms...`),await new Promise(i=>setTimeout(i,e*1e3))):(console.error("Failed to load contacts after all retries"),m(P,[]))}m(pt,!1)}async function Me(e){try{if(console.log("Loading messages for contact:",e),e.startsWith("group_")||e.includes("@g.us")){const f=e.includes("@g.us")?e:e.replace("group_","");try{const l=await(await fetch(`/api/mongodb/messages/search?searchText=${encodeURIComponent(f)}&limit=100`)).json();if(console.log("Group messages response:",l),l.success&&l.messages){console.log(`Total group messages found: ${l.messages.length}`);const d=l.messages.filter(u=>{var _;if(!(((_=u.metadata)==null?void 0:_.isGroup)||u.to&&u.to.includes("@g.us")||u.from&&u.from.includes("@g.us")))return console.log("Skipping non-group message in group chat:",u),!1;const g=u.from?u.from.replace("@g.us",""):"",y=u.to?u.to.replace("@g.us",""):"",b=f.replace("@g.us","");return g===b||y===b});console.log(`Group messages after filtering: ${d.length}`);const p=d.map(u=>{var b;const x=u.fromMe!==void 0?u.fromMe:u.from===null;let g="",y="";if(x)g="You",y="You";else if(u.metadata&&u.metadata.groupParticipantPhone)g=u.metadata.groupParticipantPhone,y=J(g),console.log(`Using groupParticipantPhone: ${g}`);else if(u.metadata&&u.metadata.realPhoneNumber)g=u.metadata.realPhoneNumber,y=J(g),console.log(`Using realPhoneNumber: ${g}`);else if(u.metadata&&u.metadata.senderNumber)g=u.metadata.senderNumber,y=J(g),console.log(`Using senderNumber: ${g}`);else if(u.from&&!u.from.includes("@g.us"))g=u.from.replace("@c.us",""),y=J(g),console.log(`Using from field: ${g}`);else if(u.metadata&&u.metadata.author){const _=u.metadata.author.replace("@lid","").replace("@c.us","").replace("@g.us","");/^\d{8,}$/.test(_)?(g=_,y=J(g),console.log(`Using author field: ${g}`)):(g="Unknown",y="Unknown",console.log(`Author field not a valid phone number: ${_}`))}else g=u.from||"Unknown",y="Unknown",console.log(`Using fallback from field: ${g}`);return console.log(`Message ${u._id} - senderPhone: ${g}, senderName: ${y}, metadata:`,u.metadata),{id:((b=u._id)==null?void 0:b.toString())||u.id||Date.now().toString(),direction:u.direction||(x?"sent":"received"),type:u.type||"text",content:u.body||u.content||"",from:y,fromPhone:g,to:f.replace("@g.us",""),timestamp:new Date(u.timestamp||u.createdAt),status:u.status||"delivered",contact:f,isGroup:!0,groupId:f,realPhoneNumber:g}});m(F,p.reverse()),console.log("Group messages loaded:",t(F))}else m(F,[]),console.log("No group messages found for:",f)}catch(v){console.error("Error loading group messages:",v),m(F,[])}return}const s=e.includes("@c.us")?e:`${e}@c.us`,c=await(await fetch(`/api/mongodb/messages/search?searchText=${encodeURIComponent(e)}&limit=100`)).json();if(console.log("Messages response:",c),c.success&&c.messages){console.log(`Total messages found: ${c.messages.length}`);const f=c.messages.filter(l=>{var g;if(((g=l.metadata)==null?void 0:g.isGroup)||l.to&&l.to.includes("@g.us")||l.from&&l.from.includes("@g.us"))return console.log("Skipping group message in individual contact chat:",l),!1;const p=l.from?l.from.replace("@c.us",""):"",u=l.to?l.to.replace("@c.us",""):"",x=e.replace("@c.us","");return p===x||u===x});console.log(`Messages after filtering (individual only): ${f.length}`);const v=f.map(l=>{var u,x,g,y;const d=l.fromMe!==void 0?l.fromMe:l.from===null;return(((u=l.metadata)==null?void 0:u.isGroup)||l.to&&l.to.includes("@g.us")||l.from&&l.from.includes("@g.us"))&&console.log("WARNING: Group message found in individual contact transformation:",l),{id:((x=l._id)==null?void 0:x.toString())||l.id||Date.now().toString(),direction:l.direction||(d?"sent":"received"),type:l.type||"text",content:l.body||l.content||"",from:l.from?l.from.replace("@c.us",""):"",to:l.to?l.to.replace("@c.us",""):"",timestamp:new Date(l.timestamp||l.createdAt),status:l.status||"delivered",contact:d?l.to?l.to.replace("@c.us",""):"":l.from?l.from.replace("@c.us",""):"",isGroup:!1,realPhoneNumber:((g=l.metadata)==null?void 0:g.realPhoneNumber)||((y=l.from)==null?void 0:y.replace("@c.us",""))}});m(F,v.reverse()),console.log("Filtered and transformed messages:",t(F))}else m(F,[]),console.log("No messages found for contact:",e)}catch(n){console.error("Error loading messages:",n),m(F,[])}}ma(()=>{nt&&nt.disconnect()});async function Nt(e){console.log("Selecting contact:",e),m(h,e),m(V,null),window.innerWidth<1024&&m(bt,!0),await Me(e.phone),Bt()}async function oe(){if(!t(gt).trim()||!t(h))return;const e=t(gt);m(gt,""),console.log("Sending message:",e,"to:",t(h).phone),console.log("Current messages count before sending:",t(F).length);const n={id:Date.now().toString(),direction:"sent",type:"text",content:e,from:"You",fromPhone:"agent",to:t(h).type==="group"?t(h).name:t(h).phone,timestamp:new Date,status:"sending",contact:t(h).phone,isGroup:t(h).type==="group"};m(F,[...t(F),n]),console.log("Messages count after adding temp message:",t(F).length),Bt();try{const i=t(h).type==="group"?"group":"individual",f=await(await fetch("/api/whatsapp/send-message",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({recipient:t(h).phone,message:e,messageType:i})})).json();f.success?(console.log("Message sent successfully:",f),m(F,t(F).map(v=>v.id===n.id?{...v,status:"sent"}:v)),t(h)&&(K(h,t(h).lastMessage=e),K(h,t(h).lastMessageTime=new Date),m(P,t(P).map(v=>v.phone===t(h).phone?{...v,lastMessage:e,lastMessageTime:new Date}:v))),console.log("Message sent and UI updated successfully. Final messages count:",t(F).length)):(console.error("Failed to send message to WhatsApp:",f.error),m(F,t(F).map(v=>v.id===n.id?{...v,status:"failed",error:f.error}:v)),alert(`Failed to send message: ${f.error}`))}catch(s){console.error("Error sending message:",s),m(F,t(F).map(i=>i.id===n.id?{...i,status:"failed",error:s.message}:i)),alert(`Error sending message: ${s.message}`)}}function Bt(){setTimeout(()=>{t(mt)&&K(mt,t(mt).scrollTop=t(mt).scrollHeight)},100)}function Wt(e){return!e||!(e instanceof Date)||isNaN(e.getTime())?"":e.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}function Ne(e){e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),oe())}function Te(){K(D,t(D).participants=[...t(D).participants,""])}function Ge(e){K(D,t(D).participants=t(D).participants.filter((n,s)=>s!==e))}function Pe(e,n){K(D,t(D).participants[e]=n),K(D,t(D).participants=[...t(D).participants])}async function $e(){if(!t(D).title.trim())return;const e=t(D).participants.map(n=>n.trim()).filter(n=>n.length>0);if(e.length===0){alert("Please add at least one participant");return}try{const s=await(await fetch("/api/whatsapp/create-group",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:t(D).title.trim(),participants:e})})).json();s.success?(console.log("Group created successfully:",s),m(D,{title:"",participants:[""]}),m(Ut,!1),alert("Group created successfully! You can now chat with the group.")):(console.error("Failed to create group:",s.error),alert(`Failed to create group: ${s.error}`))}catch(n){console.error("Error creating group:",n),alert(`Error creating group: ${n.message}`)}}async function Ht(){try{const n=await(await fetch("/api/contacts")).json();n.success?(m(ut,n.contacts||[]),console.log("Contacts list loaded:",t(ut)),t(P).length>0&&Ft()):(console.error("Failed to load contacts:",n.error),m(ut,[]))}catch(e){console.error("Error loading contacts:",e),m(ut,[])}}function se(){m(O,{name:"",phone:"",email:"",notes:""}),m(at,null),m(Mt,!0)}function De(e){m(O,{...e}),m(at,e),m(Mt,!0)}async function je(){if(!t(O).name.trim()||!t(O).phone.trim()){alert("Name and phone number are required");return}try{const e=t(at)?`/api/contacts/${t(at)._id}`:"/api/contacts",n=t(at)?"PUT":"POST",i=await(await fetch(e,{method:n,headers:{"Content-Type":"application/json"},body:JSON.stringify(t(O))})).json();i.success?(console.log("Contact saved successfully:",i),await Ht(),m(O,{name:"",phone:"",email:"",notes:""}),m(at,null),m(Mt,!1),alert(t(at)?"Contact updated successfully!":"Contact added successfully!")):(console.error("Failed to save contact:",i.error),alert(`Failed to save contact: ${i.error}`))}catch(e){console.error("Error saving contact:",e),alert(`Error saving contact: ${e.message}`)}}async function Ee(e){if(confirm("Are you sure you want to delete this contact?"))try{const s=await(await fetch(`/api/contacts/${e}`,{method:"DELETE"})).json();s.success?(console.log("Contact deleted successfully"),await Ht(),alert("Contact deleted successfully!")):(console.error("Failed to delete contact:",s.error),alert(`Failed to delete contact: ${s.error}`))}catch(n){console.error("Error deleting contact:",n),alert(`Error deleting contact: ${n.message}`)}}function J(e){if(!e)return"Unknown";const n=e.replace("@c.us",""),s=t(ut).find(i=>i.phone===n);return s?s.name:n}function Ae(e){if(e.isGroup){const i=e.groupId||e.to;m(P,t(P).map(c=>{if(c.type==="group"&&c.phone===i){const f={...c,lastMessage:e.content,lastMessageTime:new Date(e.timestamp),messageCount:c.messageCount+1};return console.log("Updated group contact:",{groupId:i,oldTime:c.lastMessageTime,newTime:f.lastMessageTime,message:e.content}),f}return c})),console.log("Updated group contact with new message:",i);return}const n=e.fromMe?e.to:e.realPhoneNumber||e.from;if(m(P,t(P).map(i=>{if(i.phone===n){const c={...i,lastMessage:e.content,lastMessageTime:new Date(e.timestamp),messageCount:i.messageCount+1};return console.log("Updated individual contact:",{phone:n,oldTime:i.lastMessageTime,newTime:c.lastMessageTime,message:e.content}),c}return i})),!t(P).find(i=>i.phone===n)){const i=J(n),c=i!==n?i:n.replace(/\D/g,""),f=c.split(" ").map(l=>l[0]).join("").toUpperCase().slice(0,2),v={id:Date.now(),name:c,phone:n,avatar:f,status:"offline",lastMessage:e.content,lastMessageTime:new Date(e.timestamp),messageCount:1,type:"contact"};m(P,[v,...t(P)]),console.log("New individual contact added:",v)}m(P,t(P).sort((i,c)=>new Date(c.lastMessageTime)-new Date(i.lastMessageTime)))}function Ft(){m(P,t(P).map(e=>{if(e.type==="contact"){const n=J(e.phone);if(n!==e.phone&&n!==e.name){const s=n.split(" ").map(i=>i[0]).join("").toUpperCase().slice(0,2);return{...e,name:n,avatar:s}}}return e})),console.log("Contact names refreshed from saved contacts")}async function Se(){console.log("Manually refreshing groups..."),m(pt,!0);try{const e=await fetch("/api/whatsapp/groups");if(!e.ok)throw new Error(`HTTP ${e.status}: ${e.statusText}`);const n=await e.json();if(console.log("Groups refresh response:",n),n.success&&n.groups){const s=n.groups.map((i,c)=>{let f=[],v=[];return i.participants&&Array.isArray(i.participants)&&(v=i.participants.map(l=>{const d=l.id?l.id.replace("@c.us",""):l.replace("@c.us",""),p=J(d);return{phone:d,name:p,original:l}}),f=v.map(l=>l.name)),{id:`group_${c+1e3}`,name:i.name||i.title||`Group ${c+1}`,phone:i.id,avatar:"👥",status:"online",lastMessage:f.length>0?`${f.length} participants`:"Group chat",lastMessageTime:null,messageCount:0,type:"group",participantsCount:i.participantsCount||0,participants:i.participants||[],participantNames:f,participantData:v}});m(P,t(P).filter(i=>i.type!=="group")),s.forEach(i=>{t(P).push(i)}),m(P,t(P).sort((i,c)=>new Date(c.lastMessageTime)-new Date(i.lastMessageTime))),console.log("Groups refreshed successfully:",s.length),console.log("Total contacts after refresh:",t(P).length)}else throw new Error(`Groups API returned: ${JSON.stringify(n)}`)}catch(e){console.error("Error refreshing groups:",e),alert("Failed to refresh groups. Please try again.")}finally{m(pt,!1)}}function Ie(e){m(V,{phone:e,name:J(e),type:"contact"}),window.innerWidth<1024&&m(bt,!0)}function Ue(){m(V,null)}function Fe(e){m(et,e),m(kt,!0)}ua();var ne=lr();fa(e=>{ha.title="Chat - WhatsApp Chat Portal"});var Jt=Q(ne),Yt=r(Jt),qt=r(Yt),Qt=r(qt),ie=o(r(Qt),2),le=r(ie),ce=o(le,2),ze=o(ce,2);a(ie),a(Qt);var de=o(Qt,4),pe=r(de),Tt=o(pe,2),Re=r(Tt,!0);a(Tt);var Le=o(Tt,2);a(de),a(qt);var ue=o(qt,2),Oe=r(ue);{var Be=e=>{var n=Ca();w(e,n)},We=e=>{var n=_t(),s=Q(n);{var i=f=>{var v=ka(),l=o(r(v),6);a(v),T("click",l,()=>m(Ct,!0)),w(f,v)},c=f=>{var v=_t(),l=Q(v);At(l,1,()=>t(P),St,(d,p)=>{var u=Ga(),x=r(u),g=r(x),y=r(g,!0);a(g);var b=o(g,2),_=r(b),k=r(_),M=r(k),j=o(M);{var R=A=>{var z=Ma();w(A,z)};G(j,A=>{t(p).type==="group"&&A(R)})}a(k);var S=o(k,2),U=r(S),$=o(U,2);{var E=A=>{var z=Na(),q=r(z,!0);a(z),I(X=>C(q,X),[()=>Wt(t(p).lastMessageTime)]),w(A,z)};G($,A=>{t(p).lastMessageTime&&t(p).messageCount>0&&t(p).lastMessage!=="Start a new conversation"&&A(E)})}a(S),a(_);var L=o(_,2),B=r(L);{var H=A=>{var z=_t(),q=Q(z);{var X=rt=>{var it=Ta(),Rt=Q(it),Zt=o(Rt);{var te=lt=>{var Gt=Et();I(()=>C(Gt,`+${t(p).participantNames.length-2} more`)),w(lt,Gt)};G(Zt,lt=>{t(p).participantNames.length>2&&lt(te)})}I(lt=>C(Rt,`${lt??""} `),[()=>t(p).participantNames.slice(0,2).join(", ")]),w(rt,it)},Xt=rt=>{var it=Et();I(()=>C(it,`${(t(p).participantsCount||0)??""} participants`)),w(rt,it)};G(q,rt=>{t(p).participantNames&&t(p).participantNames.length>0?rt(X):rt(Xt,!1)})}w(A,z)},Y=A=>{var z=Et();I(()=>C(z,t(p).lastMessage)),w(A,z)};G(B,A=>{t(p).type==="group"?A(H):A(Y,!1)})}a(L),a(b),a(x),a(u),I(()=>{var A;st(u,1,`p-4 border-b border-gray-100 hover:bg-gray-50 cursor-pointer transition-colors ${((A=t(h))==null?void 0:A.id)===t(p).id?"bg-blue-50 border-l-4 border-l-blue-500":""}`),st(g,1,`w-10 h-10 ${t(p).type==="group"?"bg-green-300":"bg-gray-300"} rounded-full flex items-center justify-center text-sm font-medium ${t(p).type==="group"?"text-green-700":"text-gray-700"}`),C(y,t(p).avatar),C(M,`${t(p).name??""} `),st(U,1,`w-2 h-2 rounded-full ${t(p).status==="online"?"bg-green-500":t(p).status==="away"?"bg-yellow-500":"bg-gray-400"}`)}),T("click",u,()=>Nt(t(p))),w(d,u)}),w(f,v)};G(s,f=>{t(P).length===0?f(i):f(c,!1)},!0)}w(e,n)};G(Oe,e=>{t(pt)?e(Be):e(We,!1)})}a(ue),a(Yt);var Kt=o(Yt,2),ve=r(Kt);{var He=e=>{var n=Pa(),s=r(n),i=r(s),c=r(i,!0);a(i);var f=o(i,2),v=r(f),l=r(v,!0);a(v);var d=o(v,2),p=r(d,!0);a(d),a(f);var u=o(f,2),x=r(u),g=o(x,2),y=o(g,2),b=r(y,!0);a(y),a(u),a(s),a(n),I(()=>{C(c,t(h).avatar),C(l,t(h).name),C(p,t(h).phone),st(g,1,`w-2 h-2 rounded-full ${t(h).status==="online"?"bg-green-500":t(h).status==="away"?"bg-yellow-500":"bg-gray-400"}`),C(b,t(h).status)}),T("click",x,()=>m(bt,!t(bt))),w(e,n)};G(ve,e=>{t(h)&&e(He)})}var zt=o(ve,2),Je=r(zt);{var Ye=e=>{var n=_t(),s=Q(n);At(s,1,()=>t(F),St,(i,c)=>{var f=Fa(),v=r(f),l=r(v);{var d=_=>{var k=ja(),M=r(k),j=o(M);{var R=$=>{var E=$a(),L=r(E);a(E),I(()=>C(L,`(${t(c).fromPhone??""})`)),w($,E)};G(j,$=>{t(c).fromPhone&&t(c).fromPhone!==t(c).from&&t(c).fromPhone!=="Unknown"&&$(R)})}var S=o(j,2);{var U=$=>{var E=Da(),L=r(E);a(E),I(()=>C(L,`📱 ${t(c).realPhoneNumber??""}`)),w($,E)};G(S,$=>{t(c).realPhoneNumber&&t(c).realPhoneNumber!==t(c).fromPhone&&$(U)})}a(k),I(()=>C(M,`${t(c).from??""} `)),T("click",k,()=>Fe({name:t(c).from,phone:t(c).fromPhone||t(c).realPhoneNumber||t(c).from,type:"contact"})),w(_,k)};G(l,_=>{t(c).isGroup&&t(c).direction==="received"&&_(d)})}var p=o(l,2),u=r(p,!0);a(p);var x=o(p,2),g=r(x),y=o(g);{var b=_=>{var k=Ua(),M=r(k);{var j=S=>{var U=Ea();w(S,U)},R=S=>{var U=_t(),$=Q(U);{var E=B=>{var H=Aa();w(B,H)},L=B=>{var H=_t(),Y=Q(H);{var A=q=>{var X=Sa();I(()=>_a(X,"title",t(c).error||"Failed")),w(q,X)},z=q=>{var X=Ia();w(q,X)};G(Y,q=>{t(c).status==="failed"?q(A):q(z,!1)},!0)}w(B,H)};G($,B=>{t(c).status==="sent"?B(E):B(L,!1)},!0)}w(S,U)};G(M,S=>{t(c).status==="sending"?S(j):S(R,!1)})}a(k),w(_,k)};G(y,_=>{t(c).direction==="sent"&&_(b)})}a(x),a(v),a(f),I(_=>{st(f,1,`flex ${t(c).direction==="sent"?"justify-end":"justify-start"} mb-4`),st(v,1,`max-w-xs lg:max-w-md px-4 py-2 rounded-lg ${t(c).direction==="sent"?"bg-blue-500 text-white":"bg-gray-200 text-gray-800"}`),C(u,t(c).content),C(g,`${_??""} `)},[()=>Wt(t(c).timestamp)]),w(i,f)}),w(e,n)},qe=e=>{var n=za();w(e,n)};G(Je,e=>{t(h)?e(Ye):e(qe,!1)})}a(zt),wa(zt,e=>m(mt,e),()=>t(mt));var Qe=o(zt,2);{var Ke=e=>{var n=Ra(),s=r(n),i=r(s);dt(i);var c=o(i,2);a(s),a(n),I(f=>c.disabled=f,[()=>!t(gt).trim()]),ot(i,()=>t(gt),f=>m(gt,f)),T("keypress",i,Ne),T("click",c,oe),w(e,n)};G(Qe,e=>{t(h)&&e(Ke)})}a(Kt);var Vt=o(Kt,2),Ve=r(Vt);{var Xe=e=>{var n=Qa(),s=r(n),i=r(s);a(s);var c=o(s,2);{var f=l=>{var d=La(),p=Q(d),u=r(p);a(p);var x=o(p,2),g=r(x),y=r(g,!0);a(g);var b=o(g,2),_=r(b,!0);a(b),wt(2),a(x);var k=o(x,2),M=r(k),j=o(r(M),2),R=r(j),S=o(r(R),2),U=r(S,!0);a(S),a(R);var $=o(R,2),E=o(r($),2),L=r(E,!0);a(E),a($),a(j),a(M);var B=o(M,2),H=o(r(B),2),Y=r(H),A=o(Y,2);a(H),a(B),a(k),I(z=>{C(y,z),C(_,t(V).name),C(U,t(V).phone),C(L,t(h).name)},[()=>t(V).name.charAt(0).toUpperCase()]),T("click",u,Ue),T("click",Y,()=>{const z={id:Date.now(),name:t(V).name,phone:t(V).phone,avatar:t(V).name.charAt(0).toUpperCase(),status:"offline",lastMessage:"Start a new conversation",messageCount:0,type:"contact"};Nt(z),m(V,null)}),T("click",A,()=>m(ft,!0)),w(l,d)},v=l=>{var d=qa(),p=Q(d),u=r(p),x=r(u,!0);a(u);var g=o(u,2),y=r(g,!0);a(g);var b=o(g,2),_=r(b,!0);a(b);var k=o(b,2),M=r(k),j=o(M,2),R=r(j,!0);a(j),a(k),a(p);var S=o(p,2),U=r(S),$=o(r(U),2),E=r($),L=o(r(E),2),B=r(L,!0);a(L),a(E);var H=o(E,2);{var Y=Z=>{var ct=Ha(),ht=Q(ct),xt=o(r(ht),2),ee=r(xt);a(xt),a(ht);var Lt=o(ht,2);{var ae=Pt=>{var $t=Wa(),xe=o(r($t),2),ye=r(xe);At(ye,1,()=>t(h).participantNames.slice(0,5),St,(Dt,vt,jt)=>{var Ot=Oa(),_e=r(Ot),da=r(_e,!0);a(_e),wt(2),a(Ot),I(()=>C(da,t(vt))),T("click",Ot,()=>{console.log("Participant clicked:",t(vt),"at index:",jt),console.log("Selected contact participantData:",t(h).participantData);let yt;t(h).participantData&&t(h).participantData[jt]?(yt=t(h).participantData[jt].phone,console.log("Found phone from participantData:",yt)):(yt=t(vt),console.log("Using participant name as fallback phone:",yt)),console.log("Final phone number:",yt),Ie(yt)}),w(Dt,Ot)});var la=o(ye,2);{var ca=Dt=>{var vt=Ba(),jt=r(vt);a(vt),I(()=>C(jt,`+${t(h).participantNames.length-5} more`)),w(Dt,vt)};G(la,Dt=>{t(h).participantNames.length>5&&Dt(ca)})}a(xe),a($t),w(Pt,$t)};G(Lt,Pt=>{t(h).participantNames&&t(h).participantNames.length>0&&Pt(ae)})}I(()=>C(ee,`${(t(h).participantsCount||0)??""} members`)),w(Z,ct)};G(H,Z=>{t(h).type==="group"&&Z(Y)})}a($),a(U);var A=o(U,2),z=o(r(A),2),q=r(z),X=r(q),Xt=r(X,!0);a(X),wt(2),a(q);var rt=o(q,2),it=r(rt),Rt=r(it,!0);a(it),wt(2),a(rt),a(z);var Zt=o(z,2);{var te=Z=>{var ct=Ja(),ht=r(ct),xt=r(ht),ee=r(xt);a(xt);var Lt=o(xt,2),ae=r(Lt,!0);a(Lt),a(ht),a(ct),I((Pt,$t)=>{C(ee,`Last Activity: ${Pt??""}`),C(ae,$t)},[()=>Wt(t(h).lastMessageTime),()=>t(h).lastMessageTime.toLocaleDateString()]),w(Z,ct)};G(Zt,Z=>{t(h).lastMessageTime&&Z(te)})}a(A);var lt=o(A,2),Gt=o(r(lt),2),he=r(Gt),na=o(he,2);{var ia=Z=>{var ct=Ya();w(Z,ct)};G(na,Z=>{t(h).type==="group"&&Z(ia)})}wt(2),a(Gt),a(lt),a(S),I(()=>{st(u,1,`w-20 h-20 ${t(h).type==="group"?"bg-green-300":"bg-gray-300"} rounded-full flex items-center justify-center text-2xl font-medium mx-auto mb-3 ${t(h).type==="group"?"text-green-700":"text-gray-700"}`),C(x,t(h).avatar),C(y,t(h).name),C(_,t(h).type==="group"?"Group Chat":"Individual Chat"),st(M,1,`w-3 h-3 rounded-full ${t(h).status==="online"?"bg-green-500":t(h).status==="away"?"bg-yellow-500":"bg-gray-400"}`),C(R,t(h).status),C(B,t(h).phone),C(Xt,t(F).length),C(Rt,t(h).messageCount||0)}),T("click",he,()=>m(ft,!0)),w(l,d)};G(c,l=>{t(V)?l(f):l(v,!1)})}a(n),T("click",i,()=>m(bt,!1)),w(e,n)},Ze=e=>{var n=Ka();w(e,n)};G(Ve,e=>{t(h)?e(Xe):e(Ze,!1)})}a(Vt),a(Jt);var ge=o(Jt,2);{var ta=e=>{var n=Va(),s=r(n),i=o(r(s),2),c=r(i),f=o(r(c),2);dt(f),a(c);var v=o(c,2),l=o(r(v),2);dt(l),a(v),a(i);var d=o(i,2),p=r(d),u=o(p,2);a(d),a(s),a(n),I(x=>u.disabled=x,[()=>!t(tt).trim()]),ot(f,()=>t(It),x=>m(It,x)),ot(l,()=>t(tt),x=>m(tt,x)),T("click",p,()=>m(Ct,!1)),T("click",u,re),w(e,n)};G(ge,e=>{t(Ct)&&e(ta)})}var me=o(ge,2);{var ea=e=>{var n=er(),s=r(n),i=o(r(s),2),c=r(i),f=o(r(c),2);dt(f),a(c);var v=o(c,2),l=o(r(v),2);At(l,1,()=>t(D).participants,St,(g,y,b)=>{var _=tr(),k=Q(_),M=r(k);dt(M);var j=o(M,2);{var R=$=>{var E=Xa();T("click",E,()=>Ge(b)),w($,E)};G(j,$=>{t(D).participants.length>1&&$(R)})}a(k);var S=o(k,2);{var U=$=>{var E=Za(),L=r(E);{var B=Y=>{var A=Et();I(z=>C(A,`👤 ${z??""}`),[()=>J(t(D).participants[b])]),w(Y,A)},H=Y=>{var A=Et();I(()=>C(A,`📱 ${t(D).participants[b]??""}`)),w(Y,A)};G(L,Y=>{J(t(D).participants[b])!==t(D).participants[b]?Y(B):Y(H,!1)})}a(E),w($,E)};G(S,$=>{t(D).participants[b].trim()&&$(U)})}ot(M,()=>t(D).participants[b],$=>(t(D).participants[b]=$,xa(()=>t(D)))),T("input",M,()=>Pe(b,t(D).participants[b])),w(g,_)});var d=o(l,2);a(v),a(i);var p=o(i,2),u=r(p),x=o(u,2);a(p),a(s),a(n),I(g=>x.disabled=g,[()=>!t(D).title.trim()||t(D).participants.length===0]),ot(f,()=>t(D).title,g=>K(D,t(D).title=g)),T("click",d,Te),T("click",u,()=>m(Ut,!1)),T("click",x,$e),w(e,n)};G(me,e=>{t(Ut)&&e(ea)})}var fe=o(me,2);{var aa=e=>{var n=or(),s=r(n),i=r(s),c=o(r(i),2),f=r(c),v=o(f,2);a(c),a(i);var l=o(i,2),d=r(l),p=o(r(d));At(p,5,()=>t(ut),St,(g,y)=>{var b=ar(),_=r(b),k=r(_,!0);a(_);var M=o(_),j=r(M,!0);a(M);var R=o(M),S=r(R,!0);a(R);var U=o(R),$=r(U,!0);a(U);var E=o(U),L=r(E),B=r(L),H=o(B,2);a(L),a(E),a(b),I(()=>{C(k,t(y).name),C(j,t(y).phone),C(S,t(y).email||"-"),C($,t(y).notes||"-")}),T("click",B,()=>De(t(y))),T("click",H,()=>Ee(t(y)._id)),w(g,b)}),a(p),a(d),a(l);var u=o(l,2);{var x=g=>{var y=rr(),b=o(r(y),6);a(y),T("click",b,se),w(g,y)};G(u,g=>{t(ut).length===0&&g(x)})}a(s),a(n),T("click",f,se),T("click",v,()=>m(ft,!1)),w(e,n)};G(fe,e=>{t(ft)&&e(aa)})}var be=o(fe,2);{var ra=e=>{var n=sr(),s=r(n),i=r(s),c=r(i,!0);a(i);var f=o(i,2),v=r(f),l=o(r(v),2);dt(l),a(v);var d=o(v,2),p=o(r(d),2);dt(p),a(d);var u=o(d,2),x=o(r(u),2);dt(x),a(u);var g=o(u,2),y=o(r(g),2);ya(y),a(g),a(f);var b=o(f,2),_=r(b),k=o(_,2),M=r(k,!0);a(k),a(b),a(s),a(n),I(j=>{C(c,t(at)?"Edit Contact":"Add New Contact"),k.disabled=j,C(M,t(at)?"Update Contact":"Add Contact")},[()=>!t(O).name.trim()||!t(O).phone.trim()]),ot(l,()=>t(O).name,j=>K(O,t(O).name=j)),ot(p,()=>t(O).phone,j=>K(O,t(O).phone=j)),ot(x,()=>t(O).email,j=>K(O,t(O).email=j)),ot(y,()=>t(O).notes,j=>K(O,t(O).notes=j)),T("click",_,()=>m(Mt,!1)),T("click",k,je),w(e,n)};G(be,e=>{t(Mt)&&e(ra)})}var oa=o(be,2);{var sa=e=>{var n=ir(),s=r(n),i=r(s),c=o(r(i),2);a(i);var f=o(i,2);{var v=l=>{var d=nr(),p=r(d),u=r(p),x=r(u,!0);a(u);var g=o(u,2),y=r(g,!0);a(g),wt(2),a(p);var b=o(p,2),_=o(r(b),2),k=r(_),M=o(r(k),2),j=r(M,!0);a(M),a(k);var R=o(k,2),S=o(r(R),2),U=r(S,!0);a(S),a(R),a(_),a(b);var $=o(b,2),E=o(r($),2),L=r(E),B=o(L,2);a(E),a($),a(d),I(H=>{C(x,H),C(y,t(et).name),C(j,t(et).phone),C(U,t(et).type)},[()=>t(et).name.charAt(0).toUpperCase()]),T("click",L,()=>{const H={id:Date.now(),name:t(et).name,phone:t(et).phone,avatar:t(et).name.charAt(0).toUpperCase(),status:"offline",lastMessage:"Start a new conversation",messageCount:0,type:"contact"};Nt(H),m(kt,!1)}),T("click",B,()=>{m(kt,!1),m(ft,!0)}),w(l,d)};G(f,l=>{t(et)&&l(v)})}a(s),a(n),T("click",c,()=>m(kt,!1)),w(e,n)};G(oa,e=>{t(kt)&&e(sa)})}I(()=>{Tt.disabled=t(pt),C(Re,t(pt)?"Loading...":"🔄 Refresh Groups"),st(Vt,1,`w-80 bg-gray-50 flex-shrink-0 ${t(bt)?"block":"hidden"} lg:block shadow-sm`)}),T("click",le,()=>m(ft,!0)),T("click",ce,()=>m(Ut,!0)),T("click",ze,()=>m(Ct,!0)),T("click",pe,re),T("click",Tt,Se),T("click",Le,Ft),w(we,ne),ba()}export{hr as component};
